using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace PCf_Explorer_Sol
{
	// Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
	// To generate Base64 string for Images below, you can use https://www.base64-image.de/
	//https://github.com/yesadahmed/PCF-Explorer
	[Export(typeof(IXrmToolBoxPlugin)),
		ExportMetadata("Name", "PCF-Explorer"),
		ExportMetadata("Description", "A tool to explore PCF control dependencies (properties, dataset, resources, entities and solution). Works with OAUTH/Certifcate Connection."),
		// Please specify the base64 content of a 32x32 pixels image
		ExportMetadata("SmallImageBase64", "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"),
		// Please specify the base64 content of a 80x80 pixels image
		ExportMetadata("BigImageBase64", "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"),
		ExportMetadata("BackgroundColor", "#f0f8ff"),
		ExportMetadata("PrimaryFontColor", "Black"),
		ExportMetadata("SecondaryFontColor", "Gray")]
	public class MyPlugin : PluginBase
	{
		public override IXrmToolBoxPluginControl GetControl()
		{
			return new MyPluginControl();
		}

		/// <summary>
		/// Constructor 
		/// </summary>
		public MyPlugin()
		{
			// If you have external assemblies that you need to load, uncomment the following to 
			// hook into the event that will fire when an Assembly fails to resolve
			// AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
		}

		/// <summary>
		/// Event fired by CLR when an assembly reference fails to load
		/// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
		/// For example, a folder named Sample.XrmToolBox.MyPlugin 
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="args"></param>
		/// <returns></returns>
		private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
		{
			Assembly loadAssembly = null;
			Assembly currAssembly = Assembly.GetExecutingAssembly();

			// base name of the assembly that failed to resolve
			var argName = args.Name.Substring(0, args.Name.IndexOf(","));

			// check to see if the failing assembly is one that we reference.
			List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
			var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

			// if the current unresolved assembly is referenced by our plugin, attempt to load
			if (refAssembly != null)
			{
				// load from the path to this plugin assembly, not host executable
				string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
				string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
				dir = Path.Combine(dir, folder);

				var assmbPath = Path.Combine(dir, $"{argName}.dll");

				if (File.Exists(assmbPath))
				{
					loadAssembly = Assembly.LoadFrom(assmbPath);
				}
				else
				{
					throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
				}
			}

			return loadAssembly;
		}
	}
}